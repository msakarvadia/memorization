This code closely follows and is adapted from: 
